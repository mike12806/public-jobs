name: Hourly Non Docker Host Update Check

on:
  schedule:
    - cron: "0 * * * *"  # Runs hourly at the top of every hour
  workflow_dispatch:  # Allows manual triggering from GitHub Actions UI

concurrency:
  group: non_docker_hosts_hourly_update
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout gh_hdc
        uses: actions/checkout@v6
        with:
          repository: mike12806/gh_hdc
          token: ${{ secrets.GH_HDC_PAT }}
          path: gh_hdc

      - name: Prefer IPv4 over IPv6
        run: |
          # Force IPv4 preference to avoid Tailscale IPv6 connectivity issues
          echo 'precedence ::ffff:0:0/96 100' | sudo tee -a /etc/gai.conf

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          hostname: github-runner-non-docker-hosts
          version: latest

      - name: Debug connectivity to subnets
        env:
          UDM_PASSWORD: ${{ secrets.UDM_SSH_PASSWORD }}
        run: |
          echo "=== Testing connectivity to 192.168.1.1 (UDM) ==="
          
          # Test ping to UDM
          echo "Ping test to UDM (IPv4):"
          ping -4 -c 3 192.168.1.1 || echo "Ping to UDM failed"
          
          # Test SSH port on UDM
          echo "SSH port test to UDM:"
          nc -zv -w 5 192.168.1.1 22 || echo "Port 22 unreachable on UDM"
          
          # Try SSH to UDM (non-interactive command)
          echo "SSH test to UDM:"
          sshpass -p "${UDM_PASSWORD}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@192.168.1.1 'echo "SSH to UDM successful"; uname -a' || echo "SSH to UDM failed"
          
          echo ""
          echo "=== Testing connectivity to 192.168.5.22 (Bastion) ==="
          
          # Test ping to bastion
          echo "Ping test to bastion (IPv4):"
          ping -4 -c 3 192.168.5.22 || echo "Ping to bastion failed"
          
          # Test SSH port on bastion
          echo "SSH port test to bastion:"
          nc -zv -w 5 192.168.5.22 22 || echo "Port 22 unreachable on bastion"
          
          echo ""
          echo "=== Tailscale Status ==="
          tailscale status | head -20
          
          echo ""
          echo "=== Tailscale Routes ==="
          tailscale status --json | jq -r '.Peer[] | select(.AllowedIPs) | {hostname: .HostName, routes: .AllowedIPs}' || echo "No routes found"

      - name: Cache pipx and ansible
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/bin
            ~/.local/pipx
          key: ${{ runner.os }}-pipx-ansible-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pipx-ansible-

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3-pip python3-venv pipx sshpass openssh-client
          pipx install ansible
          pipx ensurepath
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Write SSH Private Key to File
        run: |
          echo "${{ secrets.MIKEYSSHKEYLINODE }}" | sed 's/\\n/\n/g' > /tmp/mike_ssh_key
          chmod 600 /tmp/mike_ssh_key

      - name: Write SSH Public Key to File
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MIKESSHKEYLINODEPUB }}" | sed 's/\\n/\n/g' >> ~/.ssh/authorized_keys
          chmod 600 ~/.ssh/authorized_keys

      - name: Run Ansible Playbook
        working-directory: gh_hdc/ansible  # Correct path
        env:
          ANSIBLE_SSH_PASS: ${{ secrets.ANSIBLE_SSH_PASSWORD_1 }}
          ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3
          ANSIBLE_GATHERING: smart
          ANSIBLE_TIMEOUT: 30
          ANSIBLE_STDOUT_CALLBACK: ansible.builtin.default
          ANSIBLE_CALLBACK_RESULT_FORMAT: yaml
          ANSIBLE_HOST_KEY_CHECKING: false
        run: |
          pipx run --spec ansible ansible-playbook playbooks/playbook_kubernetes_node_update.yaml \
            -i inventory/kubernetes_hosts \
            -u root \
            --private-key=/tmp/mike_ssh_key \
            --extra-vars "ansible_ssh_pass=${ANSIBLE_SSH_PASS} ansible_ssh_common_args='-o StrictHostKeyChecking=no'"

      - name: Run Ansible Playbook
        working-directory: gh_hdc/ansible  # Correct path
        env:
          ANSIBLE_SSH_PASS: ${{ secrets.ANSIBLE_SSH_PASSWORD_1 }}
          ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3
          ANSIBLE_GATHERING: smart
          ANSIBLE_TIMEOUT: 30
          ANSIBLE_STDOUT_CALLBACK: ansible.builtin.default
          ANSIBLE_CALLBACK_RESULT_FORMAT: yaml
          ANSIBLE_HOST_KEY_CHECKING: false
        run: |
          pipx run --spec ansible ansible-playbook playbooks/playbook_kubernetes_node_update.yaml \
            -i inventory/non_docker_lxc \
            -u root \
            --private-key=/tmp/mike_ssh_key \
            --extra-vars "ansible_ssh_pass=${ANSIBLE_SSH_PASS} ansible_ssh_common_args='-o StrictHostKeyChecking=no'"

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/mike_ssh_key
          rm -rf ~/.ssh/authorized_keys
          rm -rf ~/.ssh
