name: Validate Kubernetes Manifests

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-manifests:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Validate Argo CD Application Manifests
        run: |
          # Function to validate Argo Application manifest
          validate_argo_manifest() {
            local file="$1"
            
            # --- FIX: Capture output instead of checking exit code ---
            # yq returns exit code 0 even if select returns nothing.
            # We capture the output; if it's empty, the file is not an Argo App.
            local is_argo_app
            is_argo_app=$(yq eval 'select(.kind == "Application" and .apiVersion == "argoproj.io/v1alpha1")' "$file")

            if [ -z "$is_argo_app" ]; then
              echo "⚠️ Skipping $file - Not an Argo Application manifest"
              return 0
            fi
            # --------------------------------------------------------

            # Validate required fields
            if ! yq eval '.spec.destination.namespace' "$file" > /dev/null 2>&1; then
              echo "❌ Invalid Argo Application manifest: $file - Missing .spec.destination.namespace"
              return 1
            fi

            if ! yq eval '.spec.sources[] | select(. != null)' "$file" > /dev/null 2>&1; then
              echo "❌ Invalid Argo Application manifest: $file - Missing or empty .spec.sources"
              return 1
            fi

            # Validate structure with kubectl
            if ! kubectl apply --dry-run=client -f "$file" > /dev/null 2>&1; then
              echo "❌ Invalid Kubernetes manifest structure: $file"
              kubectl apply --dry-run=client -f "$file"
              return 1
            fi

            echo "✅ Valid Argo Application manifest: $file"
            return 0
          }

          failed=0
          
          # Process each manifest in kubernetes/apps
          for file in kubernetes/apps/*.yaml; do
            if [ -f "$file" ]; then
              echo "Processing $file..."
              if ! validate_argo_manifest "$file"; then
                failed=1
              fi
            fi
          done

          if [ "$failed" -eq 1 ]; then
            echo "❌ Validation failed"
            exit 1
          else
            echo "✅ All manifests are valid"
          fi
